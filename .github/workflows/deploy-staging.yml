name: Promote Dev to Staging

on:
  workflow_dispatch:
    inputs:
      dev_run_id:
        description: 'GitHub Actions run ID from dev deployment (leave empty to use latest dev image)'
        required: false
        type: string
      confirm_promotion:
        description: 'Confirm promotion to staging'
        required: true
        default: false
        type: boolean

permissions:
  contents: read
  id-token: write
  actions: read

env:
  REGISTRY: fbdevygfwoiacr.azurecr.io
  AZURE_RESOURCE_GROUP: farmersbank-microservices-dev
  AKS_CLUSTER_NAME: farmersbank-aks

jobs:
  validate-inputs:
    name: Validate Promotion Request
    runs-on: ubuntu-latest
    
    steps:
    - name: Validate promotion confirmation
      run: |
        if [ "${{ github.event.inputs.confirm_promotion }}" != "true" ]; then
          echo "‚ùå Promotion not confirmed. Please check the 'Confirm promotion to staging' option to proceed."
          exit 1
        fi
        
        echo "‚úÖ Staging promotion confirmed"
        echo "üéØ Target environment: Staging"
        echo "üì¶ Dev run ID: ${{ github.event.inputs.dev_run_id }}"
        echo "üë§ Requested by: ${{ github.actor }}"

  get-dev-image:
    name: Get Dev Image Tag
    runs-on: ubuntu-latest
    needs: validate-inputs
    outputs:
      image_tag: ${{ steps.get-image.outputs.image_tag }}
    
    steps:
    - name: Get deployed dev image tag
      id: get-image
      run: |
        # If dev_run_id is provided, try to get the image from that run
        if [ -n "${{ github.event.inputs.dev_run_id }}" ]; then
          echo "Getting image tag from dev run ID: ${{ github.event.inputs.dev_run_id }}"
          # For now, we'll use the latest image since we can't easily access artifacts from other runs
          IMAGE_TAG="latest"
        else
          echo "Using latest dev image"
          IMAGE_TAG="latest"
        fi
        
        # In a real scenario, you might query ACR for the latest image or use a specific tag pattern
        echo "image_tag=${{ env.REGISTRY }}/farmersbank/memberservices:latest" >> $GITHUB_OUTPUT
        echo "üì¶ Will deploy image: ${{ env.REGISTRY }}/farmersbank/memberservices:latest"

  deploy-to-staging:
    name: Deploy MemberServices to Staging
    runs-on: ubuntu-latest
    needs: [validate-inputs, get-dev-image]
    environment: 
      name: staging
      url: https://staging.farmersbank.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AKS_CLUSTER_NAME }} \
          --overwrite-existing

    - name: Create staging namespace
      run: |
        kubectl create namespace member-services-staging --dry-run=client -o yaml | kubectl apply -f -
        echo "‚úÖ Staging namespace ready"

    - name: Prepare staging deployment
      run: |
        IMAGE_TAG="${{ needs.get-dev-image.outputs.image_tag }}"
        
        echo "Preparing staging deployment with dev image: $IMAGE_TAG"
        
        # Update staging deployment manifest with the same image from dev
        sed "s|image: fbdevygfwoiacr.azurecr.io/farmersbank/memberservices:.*|image: ${IMAGE_TAG}|g" \
            k8s/memberservices/staging-deployment.yaml > staging-deployment-temp.yaml
        
        echo "‚úÖ Deployment manifest prepared with dev image"
        echo "DEV_IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    - name: Deploy to staging
      run: |
        echo "üöÄ Promoting dev image to staging environment..."
        echo "üì¶ Using same image as dev: ${{ env.DEV_IMAGE_TAG }}"
        
        # Apply staging deployment
        kubectl apply -f staging-deployment-temp.yaml
        
        # Clean up temp file
        rm staging-deployment-temp.yaml
        
        echo "‚úÖ Staging deployment applied with dev image"

    - name: Wait for deployment rollout
      run: |
        echo "‚è≥ Waiting for staging deployment to complete..."
        kubectl rollout status deployment/memberservices-api-staging -n member-services-staging --timeout=600s
        
        echo "‚úÖ Staging deployment completed successfully"

    - name: Verify staging deployment
      run: |
        echo "üîç Verifying staging deployment..."
        
        # Check deployment status
        kubectl get deployments -n member-services-staging
        
        echo ""
        echo "Pod Status:"
        kubectl get pods -n member-services-staging
        
        echo ""
        echo "Service Status:"
        kubectl get services -n member-services-staging
        
        echo ""
        echo "HPA Status:"
        kubectl get hpa -n member-services-staging

    - name: Get staging service info
      run: |
        echo "üåê Staging Service Information:"
        
        # Wait a moment for LoadBalancer to get IP
        sleep 30
        
        EXTERNAL_IP=$(kubectl get svc memberservices-api-service-staging -n member-services-staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "Pending")
        
        if [ "$EXTERNAL_IP" != "Pending" ] && [ -n "$EXTERNAL_IP" ]; then
          echo "‚úÖ Staging service is accessible at:"
          echo "   HTTP: http://$EXTERNAL_IP"
          echo "   Health: http://$EXTERNAL_IP/health"
          echo "   gRPC: $EXTERNAL_IP:5001"
        else
          echo "‚è≥ External IP not yet assigned. Use this command to check later:"
          echo "   kubectl get svc memberservices-api-service-staging -n member-services-staging"
        fi

    - name: Staging deployment summary
      run: |
        echo ""
        echo "üéâ Staging Promotion Complete!"
        echo "=============================="
        echo "Environment: Staging"
        echo "Namespace: member-services-staging"
        echo "Image: ${{ env.DEV_IMAGE_TAG }}"
        echo "Source: Same image as deployed to dev"
        echo "Replicas: 2 (auto-scaling enabled: 2-6 pods)"
        echo "Promoted by: ${{ github.actor }}"
        echo "Promotion time: $(date -u)"
        echo ""
        echo "üß™ Ready for staging validation!"
        echo "üìä Monitor with: kubectl get all -n member-services-staging"