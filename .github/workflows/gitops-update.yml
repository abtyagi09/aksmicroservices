name: GitOps - Build and Update Deployment Manifests

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'gitops/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging

permissions:
  contents: write
  id-token: write
  actions: read

env:
  REGISTRY: fbdevygfwoiacr.azurecr.io
  AZURE_RESOURCE_GROUP: farmersbank-microservices-dev
  GITOPS_PATH: gitops/environments

jobs:
  build-and-push-images:
    name: Build and Push Images for GitOps
    runs-on: ubuntu-latest
    
    outputs:
      memberservices-image-tag: ${{ steps.generate-tags.outputs.memberservices-tag }}
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate image tags
      id: generate-tags
      run: |
        SHORT_SHA=${GITHUB_SHA:0:7}
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        
        # Generate unique tag with gitops prefix
        MEMBERSERVICES_TAG="${{ env.REGISTRY }}/farmersbank/memberservices:gitops-${SHORT_SHA}-${TIMESTAMP}"
        
        echo "memberservices-tag=$MEMBERSERVICES_TAG" >> $GITHUB_OUTPUT
        echo "short-sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        
        echo "ğŸ·ï¸ Generated GitOps Image Tags:"
        echo "   MemberServices: $MEMBERSERVICES_TAG"

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Azure Container Registry
      run: |
        az acr login --name fbdevygfwoiacr

    - name: Build and push MemberServices image
      run: |
        echo "ğŸ”¨ Building MemberServices for GitOps deployment..."
        
        # Build with gitops-specific tag
        docker build \
          -t ${{ steps.generate-tags.outputs.memberservices-tag }} \
          -f src/Services/MemberServices/Dockerfile \
          .
        
        echo "ğŸ“¦ Pushing to Azure Container Registry..."
        docker push ${{ steps.generate-tags.outputs.memberservices-tag }}
        
        echo "âœ… MemberServices image built and pushed successfully"
        echo "   Image: ${{ steps.generate-tags.outputs.memberservices-tag }}"

    - name: Save image tags as artifacts
      run: |
        mkdir -p artifacts
        echo "${{ steps.generate-tags.outputs.memberservices-tag }}" > artifacts/memberservices-image-tag.txt
        
        echo "ğŸ“„ Artifact Contents:"
        cat artifacts/memberservices-image-tag.txt

    - name: Upload image tag artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gitops-image-tags
        path: artifacts/
        retention-days: 30

  update-gitops-manifests:
    name: Update GitOps Manifests
    runs-on: ubuntu-latest
    needs: build-and-push-images
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Download image tag artifacts
      uses: actions/download-artifact@v4
      with:
        name: gitops-image-tags
        path: artifacts/

    - name: Get deployment info
      id: deployment-info
      run: |
        NEW_IMAGE_TAG=$(cat artifacts/memberservices-image-tag.txt)
        SHORT_SHA=${GITHUB_SHA:0:7}
        
        echo "new_image_tag=$NEW_IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "commit_sha=$GITHUB_SHA" >> $GITHUB_OUTPUT
        
        echo "ğŸ¯ GitOps Deployment Info:"
        echo "   New Image: $NEW_IMAGE_TAG"
        echo "   Commit SHA: $GITHUB_SHA"
        echo "   Short SHA: $SHORT_SHA"

    - name: Update dev environment manifest
      run: |
        echo "ğŸ”„ Updating dev environment manifest..."
        
        # Update the image in dev manifest
        sed -i "s|image: ${{ env.REGISTRY }}/farmersbank/memberservices:.*|image: ${{ steps.deployment-info.outputs.new_image_tag }}|g" \
          ${{ env.GITOPS_PATH }}/dev/memberservices.yaml
        
        echo "âœ… Updated dev manifest with image: ${{ steps.deployment-info.outputs.new_image_tag }}"
        
        # Show the change
        echo "ğŸ“‹ Updated manifest content:"
        grep "image: ${{ env.REGISTRY }}/farmersbank/memberservices" ${{ env.GITOPS_PATH }}/dev/memberservices.yaml || echo "No image line found"

    - name: Update staging environment manifest (if requested)
      if: github.event.inputs.environment == 'staging' || github.event_name == 'workflow_dispatch'
      run: |
        echo "ğŸ”„ Updating staging environment manifest..."
        
        # Update the image in staging manifest  
        sed -i "s|image: ${{ env.REGISTRY }}/farmersbank/memberservices:.*|image: ${{ steps.deployment-info.outputs.new_image_tag }}|g" \
          ${{ env.GITOPS_PATH }}/staging/memberservices.yaml
        
        echo "âœ… Updated staging manifest with image: ${{ steps.deployment-info.outputs.new_image_tag }}"
        
        # Show the change
        echo "ğŸ“‹ Updated staging manifest content:"
        grep "image: ${{ env.REGISTRY }}/farmersbank/memberservices" ${{ env.GITOPS_PATH }}/staging/memberservices.yaml || echo "No image line found"

    - name: Configure Git and commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action - GitOps"
        
        # Configure git to use the token for authenticated push
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

    - name: Commit GitOps updates
      run: |
        # Add changed manifests
        git add ${{ env.GITOPS_PATH }}/dev/memberservices.yaml
        
        if [ "${{ github.event.inputs.environment }}" == "staging" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          git add ${{ env.GITOPS_PATH }}/staging/memberservices.yaml
        fi
        
        # Check if there are changes to commit
        if git diff --cached --quiet; then
          echo "âš ï¸ No changes to commit"
        else
          # Create commit message
          ENVIRONMENTS="dev"
          if [ "${{ github.event.inputs.environment }}" == "staging" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENVIRONMENTS="dev, staging"
          fi
          
          git commit -m "ğŸš€ GitOps: Update $ENVIRONMENTS with new image
          
          Image: ${{ steps.deployment-info.outputs.new_image_tag }}
          Commit: ${{ steps.deployment-info.outputs.commit_sha }}
          
          - Built and pushed new container image
          - Updated GitOps manifests for Argo CD sync
          - Auto-generated from GitOps workflow"
          
          echo "âœ… Created GitOps commit"
          git log --oneline -1
        fi

    - name: Push changes to repository
      run: |
        git push origin HEAD:main
        echo "âœ… Pushed GitOps updates to repository"
        echo "ğŸ”„ Argo CD will automatically detect and sync changes"

  notify-argocd-sync:
    name: Notify Argo CD Sync
    runs-on: ubuntu-latest
    needs: [build-and-push-images, update-gitops-manifests]
    if: always()
    
    steps:
    - name: GitOps Deployment Summary
      run: |
        echo "ğŸ¦ Farmers Bank GitOps Build & Deploy Complete"
        echo "=============================================="
        echo ""
        
        if [ "${{ needs.build-and-push-images.result }}" == "success" ] && [ "${{ needs.update-gitops-manifests.result }}" == "success" ]; then
          echo "âœ… Image build and GitOps update successful"
          echo "ğŸ¯ New Image: ${{ needs.build-and-push-images.outputs.memberservices-image-tag }}"
          echo "ğŸ“‹ Environments Updated: dev$([ '${{ github.event.inputs.environment }}' == 'staging' ] && echo ', staging')"
          echo ""
          echo "ğŸ”„ Next Steps:"
          echo "  1. Argo CD will automatically detect manifest changes"
          echo "  2. Applications will sync with new image tags"
          echo "  3. Monitor deployment status in Argo CD dashboard"
          echo "  4. Verify application health after sync"
          echo ""
          echo "ğŸŒ Argo CD Dashboard: https://20.161.232.159"
        else
          echo "âŒ GitOps build or update failed"
          echo "ğŸ” Check workflow logs for details"
          echo ""
          echo "Build Status: ${{ needs.build-and-push-images.result }}"
          echo "Update Status: ${{ needs.update-gitops-manifests.result }}"
        fi