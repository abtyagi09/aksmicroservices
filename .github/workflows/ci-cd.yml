name: Farmers Bank Microservices CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_services:
        description: 'Services to deploy'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - memberservices
          - loansunderwriting
          - payments
          - fraudrisk

env:
  REGISTRY: fbdevygfwoiacr.azurecr.io
  AZURE_RESOURCE_GROUP: farmersbank-microservices-dev
  AKS_CLUSTER_NAME: farmersbank-aks
  
jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration Release --no-restore

    - name: Run unit tests
      run: |
        dotnet test --configuration Release --no-build --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./coverage

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        directory: ./coverage
        fail_ci_if_error: false

    - name: Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'
      continue-on-error: true

  build-images:
    name: Build Container Images
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        service: [memberservices, loansunderwriting, payments, fraudrisk]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Azure Container Registry
      run: |
        az acr login --name fbdevygfwoiacr

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push container image
      run: |
        SERVICE_NAME=${{ matrix.service }}
        
        # Use the working Dockerfile pattern
        IMAGE_TAG=${{ env.REGISTRY }}/farmersbank/${{ matrix.service }}:${{ github.sha }}
        IMAGE_TAG_LATEST=${{ env.REGISTRY }}/farmersbank/${{ matrix.service }}:latest
        
        # Build image using Dockerfile.working
        docker build \
          -t $IMAGE_TAG \
          -t $IMAGE_TAG_LATEST \
          -f Dockerfile.working \
          --build-arg SERVICE_NAME=$SERVICE_NAME \
          .
        
        # Push images
        docker push $IMAGE_TAG
        docker push $IMAGE_TAG_LATEST
        
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    - name: Save image tag
      run: |
        mkdir -p artifacts
        echo "${{ env.REGISTRY }}/farmersbank/${{ matrix.service }}:${{ github.sha }}" > artifacts/${{ matrix.service }}-image-tag.txt

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.service }}-image-tag
        path: artifacts/${{ matrix.service }}-image-tag.txt

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    services:
      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          SA_PASSWORD: IntegrationTest123!
          ACCEPT_EULA: Y
        options: >-
          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P IntegrationTest123! -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Run integration tests
      run: |
        export ConnectionStrings__DefaultConnection="Server=localhost;Database=FarmersBankTest;User Id=sa;Password=IntegrationTest123!;TrustServerCertificate=true;"
        
        # Run tests if test projects exist
        if [ -d "tests" ]; then
          dotnet test tests/ \
            --configuration Release \
            --logger "trx;LogFileName=integration-test-results.trx" \
            --collect:"XPlat Code Coverage"
        else
          echo "No test projects found, skipping integration tests"
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: |
          **/*.trx
          **/coverage.cobertura.xml

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-images
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        service: [memberservices, loansunderwriting, payments, fraudrisk]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download image artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.service }}-image-tag
        path: artifacts/

    - name: Get image tag
      run: |
        IMAGE_TAG=$(cat artifacts/${{ matrix.service }}-image-tag.txt)
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to ACR
      run: az acr login --name fbdevygfwoiacr

    - name: Run container security scan
      run: |
        # Pull the image
        docker pull ${{ env.IMAGE_TAG }}
        
        # Install Trivy
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
        
        # Run security scan
        trivy image --exit-code 0 --severity HIGH,CRITICAL \
          --format sarif --output trivy-results-${{ matrix.service }}.sarif \
          ${{ env.IMAGE_TAG }}

    - name: Upload security scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: trivy-results-${{ matrix.service }}.sarif

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AKS_CLUSTER_NAME }} \
          --overwrite-existing

    - name: Download image artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Create namespaces
      run: |
        kubectl create namespace member-services --dry-run=client -o yaml | kubectl apply -f -
        kubectl create namespace loans-underwriting --dry-run=client -o yaml | kubectl apply -f -
        kubectl create namespace payments --dry-run=client -o yaml | kubectl apply -f -
        kubectl create namespace fraud-risk --dry-run=client -o yaml | kubectl apply -f -

    - name: Deploy services to Kubernetes
      run: |
        SERVICES=("memberservices" "loansunderwriting" "payments" "fraudrisk")
        NAMESPACES=("member-services" "loans-underwriting" "payments" "fraud-risk")
        
        for i in "${!SERVICES[@]}"; do
          service=${SERVICES[$i]}
          namespace=${NAMESPACES[$i]}
          
          echo "Deploying $service to namespace $namespace..."
          
          # Get image tag
          IMAGE_TAG=$(cat artifacts/${service}-image-tag/${service}-image-tag.txt)
          
          # Update deployment manifest with new image tag
          sed "s|image: fbdevygfwoiacr.azurecr.io/farmersbank/${service}:.*|image: ${IMAGE_TAG}|g" \
              k8s/${service}/deployment.yaml > temp-${service}.yaml
          
          # Apply deployment
          kubectl apply -f temp-${service}.yaml -n $namespace
          
          # Clean up temp file
          rm temp-${service}.yaml
          
          echo "‚úÖ Deployed $service"
        done

    - name: Wait for deployments
      run: |
        echo "Waiting for all deployments to be ready..."
        kubectl wait --for=condition=available --timeout=600s deployment --all -n member-services
        kubectl wait --for=condition=available --timeout=600s deployment --all -n loans-underwriting
        kubectl wait --for=condition=available --timeout=600s deployment --all -n payments
        kubectl wait --for=condition=available --timeout=600s deployment --all -n fraud-risk

    - name: Get service status
      run: |
        echo "Service Status:"
        kubectl get services --all-namespaces -l app
        
        echo ""
        echo "Pod Status:"
        kubectl get pods --all-namespaces -l app

    - name: Run smoke tests
      run: |
        chmod +x scripts/smoke-tests.sh
        ./scripts/smoke-tests.sh dev

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    if: always()
    
    steps:
    - name: Notification
      run: |
        if [ "${{ needs.deploy-dev.result }}" == "success" ]; then
          echo "‚úÖ Farmers Bank Microservices deployed successfully to development!"
          echo "üöÄ All services are now running in AKS cluster: ${{ env.AKS_CLUSTER_NAME }}"
          echo "üìä Check service status with: kubectl get services --all-namespaces"
        else
          echo "‚ùå Deployment failed. Check the workflow logs for details."
        fi