name: Farmers Bank Microservices CI/CD

permissions:
  contents: read
  security-events: write
  id-token: write
  actions: read

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy_services:
        description: 'Services to deploy'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - memberservices
          - loansunderwriting
          - payments
          - fraudrisk

env:
  REGISTRY: fbdevygfwoiacr.azurecr.io
  AZURE_RESOURCE_GROUP: farmersbank-microservices-dev
  AKS_CLUSTER_NAME: farmersbank-aks
  
jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: |
        # Only restore existing projects to avoid missing project errors
        dotnet restore src/Services/MemberServices/MemberServices.API/MemberServices.API.csproj
        dotnet restore src/Services/MemberServices/MemberServices.Domain/MemberServices.Domain.csproj
        dotnet restore src/Services/MemberServices/MemberServices.Infrastructure/MemberServices.Infrastructure.csproj
        dotnet restore src/Shared/Common/Shared.Common.Simple.csproj

    - name: Build existing projects
      run: |
        dotnet build src/Services/MemberServices/MemberServices.API/MemberServices.API.csproj --configuration Release --no-restore
        dotnet build src/Services/MemberServices/MemberServices.Domain/MemberServices.Domain.csproj --configuration Release --no-restore
        dotnet build src/Services/MemberServices/MemberServices.Infrastructure/MemberServices.Infrastructure.csproj --configuration Release --no-restore
        dotnet build src/Shared/Common/Shared.Common.Simple.csproj --configuration Release --no-restore



  build-images:
    name: Build Container Images
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        service: [memberservices]
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Azure Container Registry
      run: |
        az acr login --name fbdevygfwoiacr

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push container image
      run: |
        IMAGE_TAG=${{ env.REGISTRY }}/farmersbank/memberservices:${{ github.sha }}
        IMAGE_TAG_LATEST=${{ env.REGISTRY }}/farmersbank/memberservices:latest
        
        # Build image using Dockerfile.memberservices
        docker build \
          -t $IMAGE_TAG \
          -t $IMAGE_TAG_LATEST \
          -f Dockerfile.memberservices \
          .
        
        # Push images
        docker push $IMAGE_TAG
        docker push $IMAGE_TAG_LATEST
        
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    - name: Save image tag
      run: |
        mkdir -p artifacts
        echo "${{ env.REGISTRY }}/farmersbank/${{ matrix.service }}:${{ github.sha }}" > artifacts/${{ matrix.service }}-image-tag.txt

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.service }}-image-tag
        path: artifacts/${{ matrix.service }}-image-tag.txt



  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-images
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    strategy:
      matrix:
        service: [memberservices]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download image artifacts
      uses: actions/download-artifact@v4
      with:
        name: ${{ matrix.service }}-image-tag
        path: artifacts/

    - name: Get image tag
      run: |
        IMAGE_TAG=$(cat artifacts/${{ matrix.service }}-image-tag.txt)
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to ACR
      run: az acr login --name fbdevygfwoiacr

    - name: Run container security scan
      run: |
        # Pull the image
        docker pull ${{ env.IMAGE_TAG }}
        
        # Install Trivy
        sudo apt-get update
        sudo apt-get install wget apt-transport-https gnupg lsb-release
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy
        
        # Run security scan
        trivy image --exit-code 0 --severity HIGH,CRITICAL \
          --format sarif --output trivy-results-${{ matrix.service }}.sarif \
          ${{ env.IMAGE_TAG }}

    - name: Upload security scan results
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: trivy-results-${{ matrix.service }}.sarif

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: development
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AKS_CLUSTER_NAME }} \
          --overwrite-existing

    - name: Download image artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Create namespaces
      run: |
        kubectl create namespace member-services --dry-run=client -o yaml | kubectl apply -f -

    - name: Deploy services to Kubernetes
      run: |
        # Only deploy MemberServices since it's the only complete service
        SERVICE="memberservices"
        NAMESPACE="member-services"
        FOLDER="memberservices"
        
        echo "Deploying $SERVICE to namespace $NAMESPACE..."
        
        # Get image tag
        IMAGE_TAG=$(cat artifacts/${SERVICE}-image-tag/${SERVICE}-image-tag.txt)
        
        # Update deployment manifest with new image tag
        sed "s|image: fbdevygfwoiacr.azurecr.io/farmersbank/${SERVICE}:.*|image: ${IMAGE_TAG}|g" \
            k8s/${FOLDER}/deployment.yaml > temp-${SERVICE}.yaml
        
        # Apply deployment
        kubectl apply -f temp-${SERVICE}.yaml
        
        # Clean up temp file
        rm temp-${SERVICE}.yaml
        
        echo "‚úÖ Deployed $SERVICE to $NAMESPACE"

    - name: Wait for deployments
      run: |
        echo "Waiting for MemberServices deployment to be ready..."
        kubectl wait --for=condition=available --timeout=600s deployment --all -n member-services

    - name: Get service status
      run: |
        echo "Service Status:"
        kubectl get services --all-namespaces -l app
        
        echo ""
        echo "Pod Status:"
        kubectl get pods --all-namespaces -l app

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-images, security-scan]
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    environment: 
      name: staging
      url: https://staging.farmersbank.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure CLI Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --name ${{ env.AKS_CLUSTER_NAME }} \
          --overwrite-existing

    - name: Download image artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Create staging namespace
      run: |
        kubectl create namespace member-services-staging --dry-run=client -o yaml | kubectl apply -f -

    - name: Deploy to staging environment
      run: |
        SERVICE="memberservices"
        NAMESPACE="member-services-staging"
        FOLDER="memberservices"
        
        echo "Deploying $SERVICE to staging namespace $NAMESPACE..."
        
        # Get image tag
        IMAGE_TAG=$(cat artifacts/${SERVICE}-image-tag/${SERVICE}-image-tag.txt)
        
        # Update staging deployment manifest with new image tag
        sed "s|image: fbdevygfwoiacr.azurecr.io/farmersbank/${SERVICE}:.*|image: ${IMAGE_TAG}|g" \
            k8s/${FOLDER}/staging-deployment.yaml > temp-staging-${SERVICE}.yaml
        
        # Apply staging deployment
        kubectl apply -f temp-staging-${SERVICE}.yaml
        
        # Clean up temp file
        rm temp-staging-${SERVICE}.yaml
        
        echo "‚úÖ Deployed $SERVICE to staging namespace $NAMESPACE"

    - name: Wait for staging deployment
      run: |
        echo "Waiting for MemberServices staging deployment to be ready..."
        kubectl wait --for=condition=available --timeout=600s deployment --all -n member-services-staging

    - name: Get staging service status
      run: |
        echo "Staging Service Status:"
        kubectl get services -n member-services-staging
        
        echo ""
        echo "Staging Pod Status:"
        kubectl get pods -n member-services-staging
        
        echo ""
        echo "Staging Service External IP:"
        kubectl get svc memberservices-api-service-staging -n member-services-staging -o jsonpath='{.status.loadBalancer.ingress[0].ip}'

    - name: Staging deployment summary
      run: |
        echo "üéØ Staging Deployment Complete!"
        echo "Environment: Staging"
        echo "Namespace: member-services-staging"
        echo "Replicas: 2 (for staging load testing)"
        echo "Auto-scaling: 2-6 pods based on CPU/Memory"
        echo "Ready for staging validation and approval for production!"


  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-staging]
    if: always()
    
    steps:
    - name: Notification
      run: |
        DEV_RESULT="${{ needs.deploy-dev.result }}"
        STAGING_RESULT="${{ needs.deploy-staging.result }}"
        
        echo "üè¶ Farmers Bank Microservices Deployment Summary"
        echo "================================================"
        echo ""
        
        if [ "$DEV_RESULT" == "success" ]; then
          echo "‚úÖ Development: Successfully deployed to member-services namespace"
        else
          echo "‚ùå Development: Deployment failed"
        fi
        
        if [ "$STAGING_RESULT" == "success" ]; then
          echo "‚úÖ Staging: Successfully deployed to member-services-staging namespace"
          echo "üéØ Staging environment ready for validation and production approval"
        elif [ "$STAGING_RESULT" == "skipped" ]; then
          echo "‚è≠Ô∏è  Staging: Deployment skipped (manual approval required)"
        else
          echo "‚ùå Staging: Deployment failed"
        fi
        
        echo ""
        echo "üìä Check service status with:"
        echo "   kubectl get services --all-namespaces -l app=memberservices-api"
        echo "   kubectl get pods --all-namespaces -l app=memberservices-api"